<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.project.subscriptionservice.dao.mapper.SubDaoMapper">

    <resultMap id="subscription" type="org.project.subscriptionservice.bean.SubscriptionEntity">
        <id column="id" property="id"/>
        <result column="plan_id" property="planId" />
        <result column="status" property="status"/>
        <result column="plan_start" property="planStart" />
        <result column="auto_renew" property="autoRenew"/>
        <result column="is_trial" property="isTrial"/>
        <result column="plan_end" property="planEnd"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="deleted_by" property="deletedBy"/>
        <association property="subscriptionPlan" javaType="org.project.subscriptionservice.bean.SubscriptionPlanEntity">
            <id column="id" property="id"/>
            <result column="name" property="name" />
            <result column="plan_ref" property="planRef" />
            <result column="description" property="description" />
            <result column="price" property="price" />
            <result column="currency" property="currency" />
            <result column="billing_cycle" property="billingCycle" />
        </association>

        <collection property="members" ofType="org.project.subscriptionservice.bean.SubscriptionMemberEntity">
            <id column="id" property="id"/>
            <result column="subscription_id" property="subscriptionId"/>
            <result column="user_id" property="userId"/>
            <result column="role_status" property="roleConstant"/>
            <result column="accept" property="accepted"/>
            <result column="invited_at" property="invitedAt"/>
            <association property="userEntity" javaType="org.project.subscriptionservice.bean.UserEntity">
                <id column="id" property="id"/>
                <result column="username" property="username"/>
                <result column="email" property="email"/>
                <result column="phone" property="phone"/>
                <result column="job" property="job"/>
                <result column="locked" property="locked"/>
                <result column="active" property="active"/>
            </association>
        </collection>
    </resultMap>

    <select id="listAll" resultMap="subscription">
        select sub.*, sp.*, sm.*, us.*
        from SUBSCRIPTION sub
        left join SUBPLANS sp on sp.ID = sub.PLAN_ID
        left join SUBSCRIPTION_MEMBER sm on sm.SUBSCRIPTION_ID  = sub.ID
        left join USERS us on us.ID = sm.USER_ID
        where sub.DELETED_AT is null and sub.CREATED_BY = #{username}

        <if test="keyword != null and keyword != ''">
            and (
            lower(sp.NAME) like concat('%', #{keyword}, '%')
            )
        </if>

        <if test="status != null">
            and sub.STATUS = #{status}
        </if>

        <if test="startDate != null">
            and sub.CREATED_AT &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            and sub.CREATED_AT &lt;= #{endDate}
        </if>

        order by sub.ID DESC
    </select>

    <select id="findById" resultMap="subscription">

        select sub.*, sp.* , sm.*, us.*
        from SUBSCRIPTION sub
            left join SUBPLANS sp on sp.ID = sub.PLAN_ID
            left join SUBSCRIPTION_MEMBER sm on sm.SUBSCRIPTION_ID = sub.ID
            left join USERS us on us.ID = sm.USER_ID
        where sub.DELETED_AT is null
          and sub.CREATED_BY = #{username} and sub.ID = #{id}
    </select>
    <select id="findByPlanId" resultMap="subscription">
        select sub.*, sp.* from SUBSCRIPTION sub
        left join SUBPLANS sp on sub.PLAN_ID = sp.ID
        where sub.DELETED_AT is null and sub.PLAN_ID = #{id}
    </select>
    <select id="checkEmailSub" resultType="java.lang.Boolean" parameterType="map">
        select case when count(1) > 0 then 1 else 0 end
        from SUBSCRIPTION sub
                 left join SUBSCRIPTION_MEMBER sm on sm.SUBSCRIPTION_ID = sub.id
        left join USERS us on us.ID = sm.USER_ID where
        sub.ID = #{id} and
        us.ID = #{userId} and
        sub.PLAN_END > #{time}
    </select>
</mapper>